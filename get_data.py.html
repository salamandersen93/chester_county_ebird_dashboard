<html>
<head>
<title>get_data.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
get_data.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">from </span><span class="s1">ebird.api </span><span class="s0">import </span><span class="s1">get_species_observations</span>
<span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">create_engine</span>
<span class="s0">from </span><span class="s1">sqlalchemy.types </span><span class="s0">import </span><span class="s1">NVARCHAR</span>
<span class="s0">from </span><span class="s1">ebird.api </span><span class="s0">import </span><span class="s1">get_notable_observations</span>

<span class="s1">engine = create_engine(</span><span class="s2">'sqlite:///C:/Users/mikea/Documents/Python Practice/PA_County_Dashboards/Data/save_pandas.db'</span><span class="s0">,</span>
                       <span class="s1">echo=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s1">sqlite_connection = engine.connect()</span>

<span class="s1">fips_data = pd.read_csv(</span><span class="s2">r'C:\Users\mikea\Documents\Python Practice\PA_County_Dashboards\Data\fips_data_updated.csv'</span><span class="s1">)</span>
<span class="s1">print(</span><span class="s2">'got fips data. '</span><span class="s1">)</span>

<span class="s1">PA_taxonomy_df = pd.read_csv(</span><span class="s2">r'C:\Users\mikea\Documents\Python Practice\PA_County_Dashboards\Data\PA_taxonomy.csv'</span><span class="s1">)</span>
<span class="s1">print(</span><span class="s2">'got taxonomy'</span><span class="s1">)</span>

<span class="s1">specCodeList = PA_taxonomy_df[</span><span class="s2">'speciesCode'</span><span class="s1">].tolist()</span>
<span class="s1">regex = re.compile(</span><span class="s2">'[@_!#$%^&amp;*()&lt;&gt;?/\|}{~:]'</span><span class="s1">)</span>
<span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(specCodeList)):</span>
    <span class="s1">specCodeList[i] = re.sub(</span><span class="s2">'[^A-Za-z0-9]+'</span><span class="s0">, </span><span class="s2">'_'</span><span class="s0">, </span><span class="s1">specCodeList[i])</span>
<span class="s1">print(</span><span class="s2">'got spec code list. '</span><span class="s1">)</span>

<span class="s1">county_user_input = </span><span class="s2">&quot;Chester&quot; </span><span class="s3">#this would be a dropdown in Flask</span>
<span class="s1">county_code_translated = fips_data.loc[fips_data[</span><span class="s2">'county'</span><span class="s1">] == county_user_input</span><span class="s0">, </span><span class="s2">'full_fips_code'</span><span class="s1">].item()</span>
<span class="s1">print(</span><span class="s2">'translated county codes. '</span><span class="s1">)</span>


<span class="s1">api_key = </span><span class="s2">'aape5hn8f10a'</span>
<span class="s0">def </span><span class="s1">append_sightings(start</span><span class="s0">, </span><span class="s1">stop): </span><span class="s3"># use this sparingly, data is expensive</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(start</span><span class="s0">, </span><span class="s1">stop):</span>
        <span class="s0">try</span><span class="s1">: </span><span class="s3"># ignore bad requests (404 errors)</span>
            <span class="s1">j = get_species_observations(api_key</span><span class="s0">, </span><span class="s1">specCodeList[i]</span><span class="s0">, </span><span class="s1">county_code_translated</span><span class="s0">, </span><span class="s1">back=</span><span class="s4">7</span><span class="s1">)</span>
            <span class="s1">records.append(j)</span>
        <span class="s0">except</span><span class="s1">:</span>
            <span class="s1">i = i+</span><span class="s4">1</span>

<span class="s1">records=[]</span>
<span class="s1">i = </span><span class="s4">0</span>
<span class="s1">j = </span><span class="s4">30</span>

<span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(len(specCodeList)):</span>
    <span class="s1">append_sightings(i</span><span class="s0">, </span><span class="s1">j)</span>
    <span class="s1">i += </span><span class="s4">30</span>
    <span class="s1">j += </span><span class="s4">30</span>
<span class="s1">print(</span><span class="s2">'appended sightings. '</span><span class="s1">)</span>

<span class="s1">records_list = [x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">records </span><span class="s0">if </span><span class="s1">x] </span><span class="s3"># removes empty lists (unsighted species, i.e. no records available)</span>
<span class="s1">print(</span><span class="s2">'assigned to list. '</span><span class="s1">)</span>

<span class="s3"># Creates DataFrame.</span>
<span class="s1">records_df = pd.DataFrame(columns = [</span><span class="s2">'speciesCode'</span><span class="s0">, </span><span class="s2">'comName'</span><span class="s0">, </span><span class="s2">'sciName'</span><span class="s0">, </span><span class="s2">'locId'</span><span class="s0">, </span><span class="s2">'howMany'</span><span class="s0">,</span>
                                     <span class="s2">'locName'</span><span class="s0">, </span><span class="s2">'obsDt'</span><span class="s0">, </span><span class="s2">'obsReviewed'</span><span class="s0">, </span><span class="s2">'locationPrivate'</span><span class="s0">, </span><span class="s2">'subId'</span><span class="s1">])</span>

<span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(records_list)):</span>
    <span class="s1">df = pd.DataFrame(records_list[i])</span>
    <span class="s1">records_df = records_df.append(df)</span>
<span class="s1">records_df = records_df.dropna()</span>
<span class="s1">print(</span><span class="s2">'saved to dataframe. '</span><span class="s1">)</span>

<span class="s1">familyNamesDict = pd.Series(PA_taxonomy_df.familyComName.values</span><span class="s0">,</span><span class="s1">index=PA_taxonomy_df.comName).to_dict()</span>
<span class="s1">records_df[</span><span class="s2">&quot;familyComName&quot;</span><span class="s1">] = records_df[</span><span class="s2">&quot;comName&quot;</span><span class="s1">].map(familyNamesDict)</span>


<span class="s3"># convert obsDt to datetime</span>
<span class="s1">records_df[</span><span class="s2">'obsDt'</span><span class="s1">] =  pd.to_datetime(records_df[</span><span class="s2">'obsDt'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'%Y-%m-%d %H:%M'</span><span class="s1">)</span>
<span class="s1">records_df[</span><span class="s2">'date'</span><span class="s1">] = pd.to_datetime(records_df[</span><span class="s2">'obsDt'</span><span class="s1">]).dt.to_period(</span><span class="s2">'d'</span><span class="s1">)</span>
<span class="s1">records_df[</span><span class="s2">'time'</span><span class="s1">] = pd.to_datetime(records_df[</span><span class="s2">'obsDt'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'%H:M'</span><span class="s1">).dt.time</span>
<span class="s1">records_df[</span><span class="s2">'hour'</span><span class="s1">] = pd.to_datetime(records_df[</span><span class="s2">'obsDt'</span><span class="s1">]).dt.hour</span>
<span class="s1">print(</span><span class="s2">'atomized datetime values. '</span><span class="s1">)</span>

<span class="s1">b = [</span><span class="s4">0</span><span class="s0">,</span><span class="s4">4</span><span class="s0">,</span><span class="s4">8</span><span class="s0">,</span><span class="s4">12</span><span class="s0">,</span><span class="s4">16</span><span class="s0">,</span><span class="s4">20</span><span class="s0">,</span><span class="s4">24</span><span class="s1">]</span>
<span class="s1">l = [</span><span class="s2">'12AM-4AM'</span><span class="s0">, </span><span class="s2">'4AM-8AM'</span><span class="s0">,</span><span class="s2">'8AM-12PM'</span><span class="s0">,</span><span class="s2">'12PM-4PM'</span><span class="s0">,</span><span class="s2">'4PM-8PM'</span><span class="s0">,</span><span class="s2">'8PM-12AM'</span><span class="s1">]</span>
<span class="s1">records_df[</span><span class="s2">'timeOfDay'</span><span class="s1">] = pd.cut(records_df[</span><span class="s2">'hour'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">bins=b</span><span class="s0">, </span><span class="s1">labels=l</span><span class="s0">, </span><span class="s1">include_lowest=</span><span class="s0">True</span><span class="s1">)</span>
<span class="s1">records_df = records_df.applymap(str)</span>
<span class="s1">print(</span><span class="s2">'converted all to strings. '</span><span class="s1">)</span>


<span class="s1">sqlite_table = </span><span class="s2">&quot;Sightings1&quot;</span>

<span class="s1">records_df.to_sql(sqlite_table</span><span class="s0">, </span><span class="s1">sqlite_connection</span><span class="s0">, </span><span class="s1">if_exists=</span><span class="s2">'replace'</span><span class="s1">)</span>
<span class="s1">print(</span><span class="s2">'complete'</span><span class="s1">)</span>


<span class="s3"># now acquiring notable sightings and inserting into separate table</span>

<span class="s1">notable_records = get_notable_observations(api_key</span><span class="s0">, </span><span class="s1">county_code_translated</span><span class="s0">, </span><span class="s1">back=</span><span class="s4">7</span><span class="s1">)</span>
<span class="s1">notable_records = [x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">notable_records </span><span class="s0">if </span><span class="s1">x]</span>

<span class="s3"># Creates DataFrame.</span>
<span class="s1">notable_records_df = pd.DataFrame(columns=[</span><span class="s2">'speciesCode'</span><span class="s0">, </span><span class="s2">'comName'</span><span class="s0">, </span><span class="s2">'sciName'</span><span class="s0">, </span><span class="s2">'locId'</span><span class="s0">, </span><span class="s2">'howMany'</span><span class="s0">,</span>
                                     <span class="s2">'locName'</span><span class="s0">, </span><span class="s2">'obsDt'</span><span class="s0">, </span><span class="s2">'obsReviewed'</span><span class="s0">, </span><span class="s2">'locationPrivate'</span><span class="s0">, </span><span class="s2">'subId'</span><span class="s0">, </span><span class="s2">'lat'</span><span class="s0">, </span><span class="s2">'lng'</span><span class="s1">])</span>
<span class="s1">df = pd.DataFrame(notable_records)</span>
<span class="s1">notable_records_df = notable_records_df.append(df)</span>
<span class="s1">notable_records_df = notable_records_df.dropna()</span>

<span class="s1">notable_records_df[</span><span class="s2">'obsDt'</span><span class="s1">] = pd.to_datetime(notable_records_df[</span><span class="s2">'obsDt'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'%Y-%m-%d %H:%M'</span><span class="s1">)</span>
<span class="s1">notable_records_df[</span><span class="s2">'date'</span><span class="s1">] = pd.to_datetime(notable_records_df[</span><span class="s2">'obsDt'</span><span class="s1">]).dt.to_period(</span><span class="s2">'d'</span><span class="s1">)</span>
<span class="s1">notable_records_df[</span><span class="s2">'time'</span><span class="s1">] = pd.to_datetime(notable_records_df[</span><span class="s2">'obsDt'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">format=</span><span class="s2">'%H:M'</span><span class="s1">).dt.time</span>
<span class="s1">notable_records_df[</span><span class="s2">'hour'</span><span class="s1">] = pd.to_datetime(notable_records_df[</span><span class="s2">'obsDt'</span><span class="s1">]).dt.hour</span>
<span class="s1">print(</span><span class="s2">'atomized datetime values. '</span><span class="s1">)</span>

<span class="s1">notable_records_df = notable_records_df.applymap(str)</span>

<span class="s1">sqlite_table_notable = </span><span class="s2">&quot;NotableSightings&quot;</span>
<span class="s1">notable_records_df.to_sql(sqlite_table_notable</span><span class="s0">, </span><span class="s1">sqlite_connection</span><span class="s0">, </span><span class="s1">if_exists=</span><span class="s2">'replace'</span><span class="s1">)</span>

</pre>
</body>
</html>